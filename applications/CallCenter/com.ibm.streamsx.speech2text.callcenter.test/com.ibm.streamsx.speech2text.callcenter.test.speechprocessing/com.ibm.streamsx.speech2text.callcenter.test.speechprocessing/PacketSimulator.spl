namespace com.ibm.streamsx.speech2text.callcenter.test.speechprocessing ;

use com.ibm.streamsx.network.ipv4::* ;
use com.ibm.streamsx.network.ipv6::* ;
use com.ibm.streamsx.network.source::* ;
use com.ibm.streamsx.network.parse::* ;
use com.ibm.streamsx.speech2text.callcenter.types::*;

composite PacketSimulator
{
	param
		expression<rstring> $connHost     : getSubmissionTimeValue("connHost");
	       	expression<uint32>  $connPort     : (uint32) getSubmissionTimeValue("connPort");
       		expression<rstring> $PcapFileDir : getSubmissionTimeValue("pcapFileDir");
	graph
		
        stream<rstring filename> TestFile = DirectoryScan()
    	{
    		param
    		   directory : $PcapFileDir ;
		   pattern : "\\.pcap$";
		   initDelay : 5.0; 
    	}

		
		stream<PacketType> PacketStream as Out = PacketFileSource(TestFile)
		{
			output
				Out : ipSrcAddr = convertIPV4AddressNumericToString(IPV4_SRC_ADDRESS()),
					IP_DST_PORT = IP_DST_PORT(), IP_PROTOCOL = IP_PROTOCOL(),
					captureSeconds =(uint32) getSeconds(getTimestamp()), PAYLOAD_DATA =
					PAYLOAD_DATA(), PAYLOAD_LENGTH = PAYLOAD_LENGTH() ;
		}

		() as TcpSink_PacketStream = TCPSink(PacketStream)
		{
			param
				role : server ;
				port : $connPort ;
				name : $connHost ;
				format : csv ;
			config
				threadedPort : queue(PacketStream, Sys.Wait, 1000000) ;
		}

}
